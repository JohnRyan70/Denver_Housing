

# Mapping the Denver Housing Market
### John Francis Ryan (jfryan70@gmail.com)

# Part Two: Exploration
## First Glances

Now that you have your data ready, you are curious about the neighborhoods. The areas with the highest and lowest median values, as well as the areas with the best and worst value changes since 2010 - they are important to you, naturally!

In order to tap into four-year neighborhood housing value changes, you merged ACS neighborhood data from the 2005-2010 five-year estimates. Because the Census Bureau uses neighborhood samples of residents and households, it discourages any cross-time comparisons shorter than five years at a time. Also, while the Census Bureau changes some of its neighborhoods every decade, the data used here arise from the same maps and thus provide the best apples-to-apples comparison of neighborhoods.

Before going ahead, it is important to prepare the data a little further. For various reasons, nine census tracts do not have a median housing value; thus, we must remove them from our analysis before we begin to show any correlations. So, let's do this!


```{r message=FALSE, warning=FALSE}


#################################
#

setwd('C:/Users/John/Denver_Housing_Project/ACS_Data/Final_Data')

load("ACSData9_14.RData")

# Noticing the nine missing values
table(is.na(ACSData9_14$MedHouseVal))

# Removing the missing values
test <- subset(ACSData9_14, is.na(MedHouseVal))
ACSData9_14nona <- subset(ACSData9_14, !is.na(MedHouseVal)) 

#Now no NA's in median housing value
table(is.na(ACSData9_14nona$MedHouseVal)) 
save(ACSData9_14nona, file = "ACSData9_14_nona.RData")

library(maptools)
library(rgdal)
library(sp)
library(ggplot2)
library(ggmap)
library(digest)
library(Hmisc)
gpclibPermit()
library(psych)
library(ggthemes)
library(plyr)
library(dplyr)
library(RColorBrewer)
library(colorspace)

```


Because you are curious about housing values in the neighborhoods, you shrink the data to only the variables of interest and then arrange the data as you wish. Then, for the sake of exploring the margins, you decide to limit the results to the top twenty census tracts. (You also inspect the data frame to make sure it is ready.) 

Before digging in deeper, you take a peek at housing values in general. 

```{r message=FALSE, warning=FALSE}

ACSData9_14nona.mhv <-ACSData9_14nona[c("Tract",
                  "JR_Name",
                  "County",
                  "MedHouseVal",
                  "MedHouseVal_10",
                  "HV_4YrChg")]
save(ACSData9_14nona.mhv, file = "ACSData9_14_nona.mhv.RData")

class(ACSData9_14nona.mhv)
class(ACSData9_14nona.mhv$MedHouseVal)

summary(ACSData9_14nona$MedHouseVal)
summary(ACSData9_14nona$MedHouseVal_10)
summary(ACSData9_14nona$HV_4YrChg)


library(plotly)
library(ggplot2)

qplot(x = MedHouseVal, data = ACSData9_14, binwidth = 10000,
      xlab = 'Median housing value',
      ylab = 'Number of neighborhoods',
      color = MedHouseVal)


ACSData9_14nona$MedHouseVal2 <-ACSData9_14nona$MedHouseVal/1000

t <- ggplot(ACSData9_14nona, aes(x=County, y=MedHouseVal2)) + stat_summary(fun.y="median", geom="bar", fill="darkgreen", color="lightgreen")
t + ylab("Middle value") + xlab("County") +
   labs(title = "Median Housing by County") +
   geom_hline(yintercept=seq(0, 380, by=10), alpha=0.10)

aggdata <-aggregate(ACSData9_14nona$MedHouseVal, by=list(ACSData9_14nona$County), 
   FUN=median, na.rm=TRUE)
aggdata
summary(ACSData9_14nona$MedHouseVal, na.rm=TRUE)

```

You notice, first, the fairly bell-shaped distribution to the data. Many neighborhoods have housing values ranging from $150K to $350K. Some neighborhoods south of the city of Denver have much higher values, some higher than the Bureau's survey can detect.

You also notice the disparity among counties, with Douglas the highest ($334,000) and Adams the lowest ($179,350), with the other three close to the Denver median ($243,100).

## Housing Values: The Highs and Lows
So, which areas have the highest median housing values in 2014? 


```{r}

ACSData9_14nona.mhv %>%
  arrange(-MedHouseVal) %>%
  subset(MedHouseVal > 600000, select = c(Tract, JR_Name, County, MedHouseVal, MedHouseVal_10, HV_4YrChg))

```

First, you discover a high proportion (45%) of the tracts exists in Arapahoe County. In fact, four of them exist very closely to each other in the Cherry Hills Village and Greenwood Village areas! The top three, in fact, are capped off at $1,000,000 due to the Census Bureau survey question. It seems that what you heard about this part of Denver is, in fact, true.

Second, Denver County itself has a respectable percentage of areas as well (30%). Third, and interestingly, Adams County has no top-twenty neighborhoods.

Which areas have the lowest median value in 2014? 
```{r}

ACSData9_14nona.mhv %>%
  arrange(MedHouseVal) %>%
  subset(MedHouseVal < 108800, select = c(Tract, JR_Name, County, MedHouseVal, MedHouseVal_10, HV_4YrChg))

```

Adams County dominates this list at 60% of all tracts including the top nine! Why might this be the case, you wonder?

You see some areas in particular: Aurora most frequently, Federal Heights, and Thornton come up quickly. You are curious to know why this is the case but choose to explore later. 

You also notice what is absent here: neither Jefferson nor Douglas Counties have a city on this particular list. 

### Housing Values Four Years Prior
You also want to have a handle on changes in housing values from 2010 to 2014. You re-arrange the data to sort by four-year changes in median housing values.

Which areas grew the most in housing values from 2010 to 2014? 

```{r message=FALSE, warning=FALSE}

qplot(x = HV_4YrChg, data = ACSData9_14, binwidth = 5,
      xlab = 'Four year change, median housing value',
      ylab = 'Number of neighborhoods')
describe(ACSData9_14$HV_4YrChg)
summary(ACSData9_14$HV_4YrChg)

ACSData9_14nona.mhv$MedHouseVal_10_2 <-ACSData9_14nona$MedHouseVal_10/1000

n <-ACSData9_14nona.mhv %>%
  filter(MedHouseVal_10 < 1000000 & HV_4YrChg < 100) %>%
  ggplot(aes(x = MedHouseVal_10_2, y = HV_4YrChg)) +
  geom_point(alpha = 0.7) + stat_smooth(method = "lm")

n + ylab("Four-year change") + xlab("Median housing value") +
   labs(title = "Four-year change, median housing (2010-2014)") +
   geom_hline(yintercept=seq(0, 20, by=10), alpha=0.10)


```

You notice in the second graph that the middle value of a neighborhood is far from uniform. Some areas experienced high growth rates - one as high as almost 200%, in fact! - likely due to its status as a new development area. You discover, overall, a slight decline (mean of -1.03, median of -1.7)! The dispersion of values - and the generally flat line - in the second graph suggest there is no uniform trend of certain housing brackets weathering the market better than others. 

While it is outside the scope of the project to explore this further at this time, it is nonetheless interesting to note.

You are curious, nonetheless, so you make separate lists of highest-growth and lowest-growth neighborhoods. Where are the highest-growth areas?

```{r}
ACSData9_14nona.mhv %>%
  arrange(-HV_4YrChg) %>%
  subset(HV_4YrChg >= 20.0, select = c(Tract, JR_Name, County, MedHouseVal, MedHouseVal_10, HV_4YrChg))

```

Two areas in Adams County grew very quickly during this period: a tract in Berkley (199%) and one in Thornton (115%). You surmise that these might be newer developments, getting their footing comparatively late. Both areas have lower-than-average values, so this might be the case. 

You also notice Denver County tracts dominate this list - with 60% of the highest-growth tracts - while Jefferson County tracts appear nowhere. Is Jefferson a more mature market?

Among areas with the highest growth, there appears to be a healthy spread of housing values. Stated another way, while some of the hottest areas began as low-value areas in 2010 (certain tracts in Berkley, Thornton, Aurora), other tracts with very respectable growth exist with fairly high housing values. The Highland neighborhood in Denver County, for example, started at $251,600 in 2010 but jumped by 35% to $339,700 four years later. The Washington Park West neighborhood had a similar pattern, jumping 22.4% up to $484,800 in 2014. 

You explore a little further, by reviewing neighborhoods with the steepest declines. What do you know about these areas?

```{r}

ACSData9_14nona.mhv %>%
  arrange(HV_4YrChg) %>%
  subset(HV_4YrChg < -22.0, select = c(Tract, JR_Name, County, MedHouseVal, MedHouseVal_10, HV_4YrChg))

```

Three counties (Adams, Arapahoe, Denver) comprise almost equally the vast majority of such areas (95%), with one in Jefferson. You also discover this leans heavily - 80 percent - toward houses in the lower quarter of the value range (below $188,900), with most (15%) in the higher quarter (above $325,000). 



You are also curious to see how the higher-value areas have performed since 2010, so you choose areas at the top tenth minimum ($444,000) and drop the highest areas ($1,000,000) for the graph because you do not have a reliable metric for four-year change (as noted above).

```{r}

ACSData9_14nona.mhv %>%
  arrange(-MedHouseVal_10) %>%
  subset(MedHouseVal_10 >= 444000 & MedHouseVal_10 < 1000000, select = c(Tract, JR_Name, County, MedHouseVal, MedHouseVal_10, HV_4YrChg))

o <-ACSData9_14nona.mhv %>%
  filter(MedHouseVal_10 >= 444000 & MedHouseVal_10 < 1000000) %>%
  ggplot(aes(x = MedHouseVal_10_2, y = HV_4YrChg)) +
  geom_point(alpha = 0.7) + stat_smooth(method = "lm")

o + ylab("Four-year change") + xlab("Median housing value, 2010") +
   labs(title = "Four-year change, median housing (2010-2014)") +
   geom_hline(yintercept=seq(0, 20, by=10), alpha=0.10)


```

Douglas and Denver counties hold a majority of the high-value neighborhoods (54%), with Arapahoe and Jefferson next (23% and 20%, respectively). Adams County only has one area, in Thornton/Todd Creek ($472,400 in 2010).

More importantly for you, you notice the majority of such neighborhoods experiencing some decline in value (65%). 


# Part Three: What Explains Housing Values? 
## First Steps

In order to understand better any potential explanations for housing values, you provide point graphs along with estimated regression lines (to highlight the best estimated pattern in the data).

For the sake of brevity, you choose to select a subset of interesting variables and display them in a series of correlations and some interesting graphs. In this way, you can begin to understand what factors appear to affect housing values the most.

You also choose to show multiple relationships together, graphically, by using a correlogram. With a correlogram [here, corrgram](https://cran.r-project.org/web/packages/corrgram/corrgram.pdf) you can display a multivariate chart of correlations, showing not only the direction but the magnitude as well!

(There is one quirk in using correlograms within R: it does not handle missing values well. In order to solve this problem, you whittle down the dataset by dropping missing values for the variables of interest, median housing values.)

What do you discover? 

```{r message=FALSE, warning=FALSE}


ACSData9_14nona2 <-ACSData9_14nona[c("MedHouseVal",
                              "Perc_18Plus",
                              "Perc_65Plus",
                              "MedAge",
                              "Perc_Under18",
                              "HHInc_Perc35to50K",
                              "HHInc_Perc35to50K_Owner",
                              "HHInc_Perc50to75K",
                              "HHInc_Perc50to75K_Owner",
                              "HHInc_Perc75to100K",
                              "HHInc_Perc75to100K_Owner",
                              "HHInc_PercUnder35K",
                              "HHInc_Own_PercUnder35K",
                              "HHInc_Perc35Kto100K",
                              "HHInc_Own_Perc35Kto100K",
                              "HHInc_PercOver100K",
                              "HHInc_Own_PercOver100K",
                              "HHs_Perc_MarriedCplFam",
                              "MedianAge",
                              "PercNotHSGrad",
                              "PercGradorProfDegree",
                              "IndInc_Perc25to35K",
                              "IndInc_Perc35to50K",
                              "IndInc_Perc50to65K",
                              "IndInc_Perc75KPlus",
                              "IndInc_Median",
                              "PercBAorMore",
                              "IndInc_PercUpto25K",
                              "IndInc_Perc25Kto75K",
                              "IndInc_Perc75KPlus",
                              "PercUnder150PercPov",
                              "Perc_Rented",
                              "MeanHrsWkd",
                              "SchlDistRnkLYr")]
save(ACSData9_14nona2, file = "ACSData9_14_nona2.RData")

library(corrgram)
corrgram(ACSData9_14nona2, order=NULL, 
         lower.panel=panel.shade,
         upper.panel=NULL,
         text.panel=panel.txt,
         main="Correlogram of data")

```


### Income and Housing

Is it true that income can help drive neighborhood housing? You are curious to focus on housing owners rather than just the neighborhood at large, figuring this to be a better representation of an individual's choice to purchase.

```{r message=FALSE, warning=FALSE}

p1 <- ggplot(aes(x = HHInc_Own_PercUnder35K, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
           labs(x="Percent of Owners with Income below $35K", y="Median House Value")
p1 + stat_smooth(method = "lm", alpha = .2, size = 0.5)

cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Own_PercUnder35K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_PercUnder35K, use = "pairwise.complete.obs", method = c("pearson"))

```

You begin to notice a fairly modest negative relationship between the percent of owners earning below $35K and the neighborhood's median house value (r = -0.469). You might expect this, given that owners with such income are unlikely to afford a high-value house. 

What about 'middle-class' incomes and housing values, however?

```{r message=FALSE, warning=FALSE}

p2 <-ggplot(aes(x = HHInc_Own_Perc35Kto100K, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Percent of Owners with Income from $35K to $100K", y="Median House Value")
p2 + stat_smooth(method = "lm", alpha = .2, size = 0.5)

cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Perc35Kto100K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Own_Perc35Kto100K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Perc35to50K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Perc35to50K_Owner, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Perc50to75K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Perc50to75K_Owner, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Perc75to100K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Perc75to100K_Owner, use = "pairwise.complete.obs", method = c("pearson"))



```

As you search even further, you notice a strong - but negative - relationship between mid-range incomes and median house values. This holds true when considering household incomes from everyone or simply owners (r = -0.638 and -0.747, respectively). This remains true when drilling down to the $35 to $50K range as well as the $50K to $75K range (r from -.50 to -.58) but much less so for the $75K to $100K range (r from -0.05 to -0.24). 

If it is true that a mortgage should not reach much further beyond 35% of one's gross income, let's take an example. Someone with an annual income of $70K can probably afford a $24K annual mortgage, which can translate to roughly $480K over 20 years (not adjusted for inflation). Thus, one can stretch far but only so far into the housing market.

You are curious and want to go further up the income ladder. Is there a relationship between higher-income owners and the houses they choose? 

```{r message=FALSE, warning=FALSE}
p3 <-ggplot(aes(x = HHInc_Own_PercOver100K, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Percent of Owners with Income at Least $100K", y="Median House Value")
p3 + stat_smooth(method = "lm", alpha = .2, size = 0.5)

cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_PercOver100K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHInc_Own_PercOver100K, use = "pairwise.complete.obs", method = c("pearson"))

```
Household income levels can be important at the higher levels. There is a strong positive relationship between a neighborhood's individual income and housing values, as well as house-owner households earning at least $100K (r = .718 and .829, respectively). If the results are to be believed, high owner-income neighborhoods tend to have higher housing values. 

You also want to explore whether individual - rather than household - income helps explain housing values. You investigate median neighborhood incomes as well as income brackets.

```{r message=FALSE, warning=FALSE}
p33 <-ggplot(aes(x = IndInc_Median, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Percent of Population with Individual Income from $25K to $75K", y="Median House Value")
p33 + stat_smooth(method = "lm", alpha = .2, size = 0.5)

cor(ACSData9_14$MedHouseVal, ACSData9_14$IndInc_Median, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$IndInc_Perc25to35K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$IndInc_Perc35to50K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$IndInc_Perc50to65K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$IndInc_Perc65to75K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$IndInc_Perc75KPlus, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$IndInc_PercUpto25K, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$IndInc_Perc25Kto75K, use = "pairwise.complete.obs", method = c("pearson"))

```
There is a strong positive relationship between a neighborhood's median individual income and housing values (r = .718). As you see above, the relationship varies when drilling down to income categories. The relationship is strongest when considering high-income saturated areas (percentage earning $75K or more; r = .822) and lowest when exploring either the percent $50 to $65K or $65K to $75K (r = .056 and .204, respectively).

### Families and Housing Values
You wonder whether the overall neighborhood's demographics have an impact on local housing. It sounds right, no? One possibility is that stable families help undergird neighborhoods, which can thus help maintain or improve housing values. You also explore whether the size of a family can affect housing.

```{r message=FALSE, warning=FALSE}

p4 <-ggplot(aes(x = HHs_Perc_MarriedCplFam, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Percent of Households as Married-Couple Families", y="Median House Value")
p4 + stat_smooth(method = "lm", alpha = .2, size = 0.5)

cor(ACSData9_14$MedHouseVal, ACSData9_14$HHs_Perc_MarriedCplFam, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHs_AvgFamilySize, use = "pairwise.complete.obs", method = c("pearson"))

```

You begin to consider this, as there appears a somewhat strong positive connection between the percentage of married-couple families in an area and the median house value (r = .4212). You suspect part of this can be due to potential unmarried owners, who are not represented here. Perhaps there is a sufficient percentage of umarried homeowners to affect the results. 

You find, surprisingly, an inverse relationship between family size and housing values (r = -0.3603). Of course, the results are at the neighborhood (not individual) value, which might account for this. 


### Adult Education and Housing Values
You start to consider the correlation between adult education and housing. It is easy to assume such a link, so you explore this in the data. You also run correlations on education groups.

```{r message=FALSE, warning=FALSE}

p6 <-ggplot(aes(x = PercBAorMore, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Percent of People with at Least Bachelor's Degree", y="Median House Value")
p6 + stat_smooth(method = "lm", alpha = .2, size = 0.5)

cor(ACSData9_14$MedHouseVal, ACSData9_14$PercBAorMore, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$PercNotHSGrad, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$PercHSGradOnly, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$PercSomeCollegetoAA, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$PercHSGradorMore, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$PercBADegreeOnly, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$PercGradorProfDegree, use = "pairwise.complete.obs", method = c("pearson"))

```
As discovered, the education level of adults in a neighborhood matters. The strongest findings link college success with housing: neighborhoods with a greater concentration of college graduates (and higher) tend to have significantly more expensive housing areas (r = .77), something even higher for graduate/professional degrees (r = .795). Conversely, areas with higher rates of high school dropouts tend to have significantly lower housing values (r = -.534). In fact, in any category exploring the percentage of people who do NOT complete (at least) a college degree, the relationship is negative. It seems the average earning power of a college degree is, in fact, important!

### Neighborhood Poverty and Housing Values
Is it true that poverty might be driving housing values? You investigate whether poverty and near-poverty rates are influential.

```{r message=FALSE, warning=FALSE}

p7 <-ggplot(aes(x = PercUnder150PercPov, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Percent of People Living Below 150 Percent of Poverty Level", y="Median House Value")
p7 + stat_smooth(method = "lm", alpha = .2, size = 0.5)

cor(ACSData9_14$MedHouseVal, ACSData9_14$PercUnder150PercPov, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$PercUnderPov, use = "pairwise.complete.obs", method = c("pearson"))

```

You notice a link between poverty rates and housing values. Areas that tend to have slightly-above-poverty - rates tend to have lower housing values (r = -.552), and a little less so for poverty rates (r = -.470). 

### House Characteristics and Housing Values

Perhaps the 'age' of the houses can have an impact on housing values. You wonder, that is, whether people tend to value 'older' houses less than their newer - and presumably sturdier - counterparts. Is it true that, as houses age, they decrease in relative value? Is it also true that neighborhoods with 'larger' houses (multi-unit structures) tend to have higher-value houses?


```{r message=FALSE, warning=FALSE}

p8 <-ggplot(aes(x = MedianHouseYr, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Median Year House Built", y="Median House Value")
p8 + stat_smooth(method = "lm", alpha = .2, size = 0.5)
cor(ACSData9_14$MedHouseVal, ACSData9_14$MedianHouseYr, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$HHs_Total_UnitsinStructure_PercTwoPlusUnitStructure, use = "pairwise.complete.obs", method = c("pearson"))

```

Do newer houses tend to receive higher appreciation values? The results here suggest otherwise, as there does not appear to be a strong pattern in the data (r = .238). Of course, it can be the case that owners can add material value to their older houses (e.g. house additions, a pool, a larger garage). 

You discover little link between the percentage of multi-unit houses and housing values (r = -0.1916). 

### Renting and Vacancies

You are also curious to see whether renting or owning has any impact on housing values, and whether vacancies tend to depress housing values. 

```{r message=FALSE, warning=FALSE}

p10 <-ggplot(aes(x = Perc_Rented, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Percent of Units Rented [not Owned]", y="Median House Value")
p10 + stat_smooth(method = "lm", alpha = .2, size = 0.5)
cor(ACSData9_14$MedHouseVal, ACSData9_14$Perc_Rented, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$Housing_Perc_Vacant, use = "pairwise.complete.obs", method = c("pearson"))

```

The results appear to be modest here, whether the percentage of renting or vacancies (r = -.340 and -0.0436, respectively).

### Working and Housing
You want to see whether the Great Recession had any long-lasting impact on neighborhood housing. You consider whether the average number of hours - as a proxy for employment status - is linked to housing values.

```{r message=FALSE, warning=FALSE}

p11 <-ggplot(aes(x = MeanHrsWkd, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Person's Average Usual Hours Worked", y="Median House Value")
p11 + stat_smooth(method = "lm", alpha = .2, size = 0.5)
cor(ACSData9_14$MedHouseVal, ACSData9_14$MeanHrsWkd, use = "pairwise.complete.obs", method = c("pearson"))

```

The results suggest otherwise, with a small correlation at best (r = 0.263). Of course, it can be partly a function of the survey, since the types (and payscales) of work people pursue can vary greatly. Alternately, it can also be considered a crude measure of the economic 'health' of a community.

### School Quality and Housing Values

Last, with all the talk about child education driving people's housing decisions, you want to see whether this holds any water.

```{r message=FALSE, warning=FALSE}

p12 <-ggplot(aes(x = SchlDistRnkLYr, y = MedHouseVal), data = ACSData9_14) +
            geom_point(alpha = .4) + 
            labs(x="School District Ranking, Prior Year", y="Median House Value")
p13 <- p12 + stat_smooth(method = "lm", alpha = .2, size = 0.5)
p13 + geom_jitter(width=.08)
cor(ACSData9_14$MedHouseVal, ACSData9_14$SchlDistRnkLYr, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$SchlDistRnk2YrAgo, use = "pairwise.complete.obs", method = c("pearson"))

```


What you find is a relatively modest correlation between a school district's performance and housing values at best(r = .3655). This is a bit surprising, given all the talk about schools and educational performance. Of course, you are not drilling down into individual schools and you are not tracking individual moves within the metropolitan area. Perhaps there is a stronger link to individual schools instead of the district. You decide that will be for a different day.

While it is possible to point to the importance of private schools, you know that the national average of private school attendance is only around 10 percent and Denver is not among the top 10 percent of large metropolitan areas for private school attendance. ([Source](http://www.citylab.com/housing/2014/08/where-private-school-enrollment-is-highest-and-lowest-across-the-us/375993))

### Population Age and Housing Values

```{r message=FALSE, warning=FALSE}
p14 <-ggplot(aes(x = MedAge, 
           y = MedHouseVal), data = ACSData9_14) +
           geom_point(alpha = .4) +
          labs(x="Neighborhood Median Age", y="Median House Value")
p14 + stat_smooth(method = "lm", alpha = .2, size = 0.5)

cor(ACSData9_14$MedHouseVal, ACSData9_14$Perc_18Plus, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$Perc_65Plus, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$MedAge, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$Perc_Under18, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$Perc_20to29, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$Perc_30to39, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$Perc_40to49, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$Perc_50to59, use = "pairwise.complete.obs", method = c("pearson"))
cor(ACSData9_14$MedHouseVal, ACSData9_14$Perc_60to69, use = "pairwise.complete.obs", method = c("pearson"))
```

Most relationships are modest, the strongest being median age (r = .4616). Some are negative, such as the percentage of people 20 to 29 or 30 to 39 (r = -0.3049 and -.2990, respectively). Perhaps it is true that not many people in their twenties purchase a house quickly, but it does not explain people in their thirties.


## Mapping Relationships Visually

### Preparing the Data 

Okay, so perhaps you - like many others - hate staring at graphs. It will make more sense to create visual maps instead. In this way, you can see how neighborhoods can vary - sometimes drastically! After all, visual maps are a powerful way to tell a data story, no?

Since you have been thinking about the downtown and immediate southern suburbs first, you have decided to narrow the maps thus. A more interactive version of various variables is available separately as a Shiny app.

Creating these types of maps takes two basic steps. First, you will use a simple yet accurate starting map to represent the Denver metropolitan area. For this stage of the project, Google's maps are sufficient.

Second, you collect some geographic files to represent the boundaries of each census tract. The Census Bureau provides shapefiles for just such an occasion, providing polygon shapes.

Third, in order to represent the variables of interest, you merge the shapefiles into your dataset.

There are a few necessary technical steps in order to use the shapefiles. You must read the GEOID variable as a character vector, and then fortify them.

```{r message=FALSE, warning=FALSE}

#  Start mapping
#  Define map source type and color


DenverMetro <- c(-106, 40.3, -104, 39.1)
DenverMetroMap <- get_map(location=DenverMetro, source = "google", 
                          maptype = "roadmap", zoom = 11, crop=FALSE)


# Add polygons from tract file
# https://www.census.gov/geo/maps-data/data/cbf/cbf_tracts.html
setwd('C:/Users/John/Denver_Housing_Project/ACS_Data/Final_Data')
getwd()
tract <- readOGR(dsn=".", layer = "cb_2014_08_tract_500k")
tract@data$GEOID<-as.character(tract@data$GEOID)


# convert polygons to data.frame
Denver_tract<-fortify(tract, region = "GEOID") 
str(Denver_tract)
Denver_tract$id <-substring(Denver_tract$id, 2) # id had extra 0 to left

str(Denver_tract$id)

library(reshape) 
Denver_tract <-rename(Denver_tract, c('id'='id2'))



##########################################
#
# Join polygons to housing value data
#

Denver_tract$id <-as.character(Denver_tract$id)
ACSData9_14nona$id <-as.character(ACSData9_14nona$id)


ACSData10_14 <-left_join(Denver_tract, ACSData9_14nona, by=c('id')) 

save(ACSData10_14, file = "ACSData10_14.RData")


###########################
# 
# Plot median housing value
# 

describe(ACSData9_14$MedHouseVal, na.rm = TRUE)
quantile(ACSData9_14$MedHouseVal, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)

# Plot median housing values

ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = MedHouseVal),
             data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(1, .3968125, .330950, .2810125, .243100, .215150, .181900, .149325, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('Median House Value by Census Tract, 2014')



#########################
#
# Plot Low-income households
#

describe(ACSData9_14$HHInc_Own_PercUnder35K, na.rm = TRUE)
quantile(ACSData9_14$HHInc_Own_PercUnder35K, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)


ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = HHInc_Own_PercUnder35K), data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(1, .184, .14, .106, .0895, .071, .05, .031, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('Percent Owners with Household Income Below $35K')

##########################################
# 
# Plot middle-income values
#

describe(ACSData9_14$HHInc_Own_Perc35Kto100K, na.rm = TRUE)
quantile(ACSData9_14$HHInc_Own_Perc35Kto100K, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)


ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = HHInc_Own_Perc35Kto100K), data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(1, .548, .4805, .41675, .355, .313, .255, .189375, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('Percent Owners with Household Income from $35K to $100K')



##########################################
# 
# Plot upper-income values
#

describe(ACSData9_14$HHInc_Own_PercOver100K, na.rm = TRUE)
quantile(ACSData9_14$HHInc_Own_PercOver100K, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)

ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = HHInc_Own_PercOver100K),
             data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(1, .748, .68, .607875, .545, .47025, .372, .289375, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('Percent Owners with Household Income Above $100K')



##########################################
# 
# Plot married-couple values
#

describe(ACSData9_14$HHs_Perc_MarriedCplFam, na.rm = TRUE)
quantile(ACSData9_14$HHs_Perc_MarriedCplFam, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)


ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = HHs_Perc_MarriedCplFam),
             data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(100, .7175, .6265, .5455, .474, .42025, .355, .278, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('Percent Married Couple Families, 2014')


##########################################
# 
# Plot percent with college degree values
#

describe(ACSData9_14$PercBAorMore, na.rm = TRUE)
quantile(ACSData9_14$PercBAorMore, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)

ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = PercBAorMore),
             data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(1, .635125, .552, .475, .394, .313625, .23175, .135, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('Percent of People with A College Degree or More')


##########################################
# 
# Plot percent of people below 150 percent poverty level values
#

describe(ACSData9_14$PercUnder150PercPov, na.rm = TRUE)
quantile(ACSData9_14$PercUnder150PercPov, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)

ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = PercUnder150PercPov),
             data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(1, .398, .3035, .217, .157, .11225, .082, .052, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('Percent Living Below 150 Perent Poverty Level')



####################################
# 
# Plot percent vacant data
#

describe(ACSData9_14$Housing_Perc_Vacant, na.rm = TRUE)
quantile(ACSData9_14$Housing_Perc_Vacant, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)

# Plot percent vacant values


ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = Housing_Perc_Vacant),
             data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(1, .09425, .073, .06, .048, .036, .0255, .012, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('Percent Housing Units Vacant by Census Tract, 2014')

####################################
# 
# Plot renter data


describe(ACSData9_14$Perc_Rented, na.rm = TRUE)
quantile(ACSData9_14$Perc_Rented, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)

# Plot percent renter built values


ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = Perc_Rented),
             data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(1, .65697053, .51911798, .41133582, .31193581, .23761539, .15011655, .07952541, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('Percent Housing Units Rented by Census Tract, 2014')


####################################
#
# Plot school district rank data

describe(ACSData9_14$SchlDistRnkLYr, na.rm = TRUE)
quantile(ACSData9_14$SchlDistRnkLYr, c(.875, .75, .625, .5, .375, .25, .125), na.rm = TRUE)

ggmap(DenverMetroMap) + 
  geom_polygon(aes(x = long, y = lat, group=id, fill = SchlDistRnkLYr),
             data = ACSData10_14, color="black", alpha = .4, size = .2) +
            scale_fill_gradientn(colours = c("red4", "red2", "red", "lightcoral", "lightblue3", "cyan4", "blue", "midnightblue"),
                       values = c(1, .763, .682, .59, .59, .558, .426, .294, 0)) +
  labs(x = 'Longitude', y = 'Latitude') + ggtitle('School District State Rank by Census Tract, 2013')


```
